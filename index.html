<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Connect Example - Sats Connect</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; align-items: center; min-height: 90vh; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 100%; max-width: 450px; text-align: center; }
        h1 { margin-bottom: 25px; font-size: 24px; color: #1c1e21; }
        .button-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        /* ... (rest of your styles) ... */
        .xverse-btn { background-color: #5630FF; color: white; }
        .xverse-btn:hover { background-color: #4520d9; }
        .unisat-btn { background-color: #FF9900; color: white; }
        .unisat-btn:hover { background-color: #e08600; }
        .magiceden-btn { background-color: #00C2FF; color: white; }
        .magiceden-btn:hover { background-color: #00a8e0; }
        #wallet-info { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background-color: #f7f7f7; text-align: left; }
        #wallet-info p { margin: 8px 0; font-size: 14px; word-wrap: break-word; }
        #wallet-info span { font-weight: 500; }
        #status.connected { color: #28a745; }
        #status.failed { color: #dc3545; }
        #error-message { margin-top: 15px; color: #dc3545; font-size: 14px; font-weight: 500; white-space: pre-wrap; }
        .provider-debug { font-size: 12px; color: #666; margin-top: 10px; }
        .critical-note { color: red; font-weight: bold; }
    </style>
    <!-- 
        Attempting to use sats-connect library from CDN.
        Using a generic path that usually points to the latest UMD build.
    -->
    <script src="https://cdn.jsdelivr.net/npm/sats-connect/dist/sats-connect.js"></script>
</head>
<body>
    <div class="container">
        <h1>Connect Your Wallet</h1>

        <div class="button-group">
            <button id="connectXverse" class="xverse-btn">Connect Xverse</button>
            <button id="connectUnisat" class="unisat-btn">Connect Unisat</button>
            <button id="connectMagicEden" class="magiceden-btn">Connect Magic Eden (Bitcoin)</button>
        </div>

        <div id="wallet-info">
            <p>Status: <span id="status">Not Connected</span></p>
            <p>Address: <span id="address">N/A</span></p>
            <p>Wallet: <span id="wallet-name">N/A</span></p>
        </div>
        <div id="error-message"></div>
        <div class="provider-debug">
            <p>Important: Open browser console (F12 or Right-click -> Inspect -> Console) for detailed logs.</p>
            <p class="critical-note">This version uses the 'sats-connect' library's `request` method.</p>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const addressEl = document.getElementById('address');
        const walletNameEl = document.getElementById('wallet-name');
        const errorEl = document.getElementById('error-message');

        // Attempt to get the sats-connect global object
        // Common names are 'satsConnect' or 'SatsConnect'
        const satsConnectGlobal = typeof satsConnect !== 'undefined' ? satsConnect : (typeof SatsConnect !== 'undefined' ? SatsConnect : null);

        function updateWalletInfo(walletFriendlyName, address) {
            statusEl.textContent = `Connected`;
            statusEl.className = 'connected';
            addressEl.textContent = address;
            walletNameEl.textContent = walletFriendlyName;
            errorEl.textContent = '';
            console.log(`${walletFriendlyName} Connected: Address - ${address}`);
        }

        function handleError(walletFriendlyName, errorMsg, errorObj) {
            statusEl.textContent = 'Connection Failed';
            statusEl.className = 'failed';
            addressEl.textContent = 'N/A';
            walletNameEl.textContent = walletFriendlyName || 'N/A';
            let fullErrorMsg = `${walletFriendlyName} Error: ${errorMsg}`;
            if (errorObj) {
                const errorObjMessage = errorObj.message || (typeof errorObj === 'string' ? errorObj : (errorObj.code ? `Code ${errorObj.code}: ${errorObj.message}`: JSON.stringify(errorObj)));
                if (errorObjMessage && errorObjMessage !== errorMsg) {
                    fullErrorMsg += `\nDetails: ${errorObjMessage}`;
                }
            }
            errorEl.textContent = fullErrorMsg;
            console.error(`${walletFriendlyName} Error: ${errorMsg}`, errorObj || 'No additional error object.');
            if (errorObj && typeof errorObj === 'object') console.dir(errorObj);
        }
        
        // --- Xverse Connection (using sats-connect library's request method) ---
        document.getElementById('connectXverse').addEventListener('click', async () => {
            const walletName = 'Xverse';
            console.log(`Attempting to connect ${walletName} (using sats-connect library's request method)...`);

            if (!satsConnectGlobal || typeof satsConnectGlobal.request !== 'function') {
                handleError(walletName, 'sats-connect library not found or `request` function is missing. Check CDN script tag and global variable name (e.g., SatsConnect).');
                console.log('satsConnectGlobal:', satsConnectGlobal); // Log to see what it is
                return;
            }
             // For Xverse, it should be automatically detected if it's the active Sats Connect compatible wallet.
            // No specific provider needs to be passed to satsConnectGlobal.request.

            const getAddressPayload = { // As per docs, this can be an object for specific purposes
                purposes: ['payment', 'ordinals'],
                message: 'Sign in to connect your Xverse payment and ordinals addresses.'
            };

            try {
                // Using null as payload for getAddresses as shown in one part of docs,
                // or an object as per other parts. Let's try with specific purposes.
                const response = await satsConnectGlobal.request("getAddresses", getAddressPayload);
                console.log(`${walletName} getAddresses response:`, response);

                if (response.status === "success") {
                    if (response.result && response.result.length > 0) {
                        // Prioritize payment address, fallback to ordinals, then first available
                        const paymentAddressItem = response.result.find(addr => addr.purpose === 'payment');
                        const ordinalsAddressItem = response.result.find(addr => addr.purpose === 'ordinals');
                        
                        if (paymentAddressItem && paymentAddressItem.address) {
                            updateWalletInfo(walletName, paymentAddressItem.address);
                        } else if (ordinalsAddressItem && ordinalsAddressItem.address) {
                             updateWalletInfo(walletName + " (Ordinals)", ordinalsAddressItem.address);
                        } else {
                            updateWalletInfo(walletName, response.result[0].address);
                        }
                    } else {
                        handleError(walletName, 'No addresses returned in success response.', response);
                    }
                } else {
                    // Handle specific error codes if needed, e.g., RpcErrorCode.USER_REJECTION
                    // The documentation for sats-connect shows error codes like RpcErrorCode.USER_REJECTION
                    // We'd need that enum or its value if we want to check response.error.code specifically.
                    // For now, generic handling.
                    console.error(`${walletName} connection failed:`, response.error);
                    handleError(walletName, `Connection failed. ${response.error.message || 'Unknown error.'}`, response.error);
                }
            } catch (err) {
                console.error(`${walletName} uncaught error:`, err);
                // err might have err.error.message as per docs, or just err.message
                const errMsg = (err.error && err.error.message) ? err.error.message : err.message;
                handleError(walletName, `An exception occurred: ${errMsg || 'Unknown exception.'}`, err);
            }
        });
        
        // --- Unisat Connection (remains the same) ---
        document.getElementById('connectUnisat').addEventListener('click', async () => {
            const walletName = 'Unisat';
            if (typeof window.unisat !== 'undefined' && typeof window.unisat.requestAccounts === 'function') {
                try {
                    const accounts = await window.unisat.requestAccounts();
                    if (accounts && accounts.length > 0) updateWalletInfo(walletName, accounts[0]);
                    else handleError(walletName, 'No accounts found or permission denied by Unisat.');
                } catch (error) { handleError(walletName, error.message || 'Error during Unisat requestAccounts.', error); }
            } else handleError(walletName, 'Unisat wallet (window.unisat with .requestAccounts) not found.');
        });

        // --- Magic Eden (Bitcoin) Connection (using sats-connect library's request method) ---
        document.getElementById('connectMagicEden').addEventListener('click', async () => {
            const walletName = 'Magic Eden (Bitcoin)';
            console.log(`Attempting to connect ${walletName} (using sats-connect library's request method)...`);

            if (!satsConnectGlobal || typeof satsConnectGlobal.request !== 'function') {
                handleError(walletName, 'sats-connect library not found or `request` function is missing. Check CDN script tag and global variable name (e.g., SatsConnect).');
                console.log('satsConnectGlobal:', satsConnectGlobal);
                return;
            }
            // Magic Eden should also be auto-detected if it's the active Sats Connect compatible wallet.
            // It's important that window.magicEden.bitcoin is available and set as the default bitcoin provider,
            // or that sats-connect can find it.

            const getAddressPayload = {
                purposes: ['payment', 'ordinals'],
                message: 'Sign in to connect your Magic Eden payment and ordinals addresses.'
            };

            try {
                const response = await satsConnectGlobal.request("getAddresses", getAddressPayload);
                console.log(`${walletName} getAddresses response:`, response);

                if (response.status === "success") {
                     if (response.result && response.result.length > 0) {
                        const paymentAddressItem = response.result.find(addr => addr.purpose === 'payment');
                        const ordinalsAddressItem = response.result.find(addr => addr.purpose === 'ordinals');
                        
                        if (paymentAddressItem && paymentAddressItem.address) {
                            updateWalletInfo(walletName, paymentAddressItem.address);
                        } else if (ordinalsAddressItem && ordinalsAddressItem.address) {
                             updateWalletInfo(walletName + " (Ordinals)", ordinalsAddressItem.address);
                        } else {
                            updateWalletInfo(walletName, response.result[0].address);
                        }
                    } else {
                        handleError(walletName, 'No addresses returned in success response.', response);
                    }
                } else {
                    console.error(`${walletName} connection failed:`, response.error);
                    handleError(walletName, `Connection failed. ${response.error.message || 'Unknown error.'}`, response.error);
                }
            } catch (err) {
                console.error(`${walletName} uncaught error:`, err);
                const errMsg = (err.error && err.error.message) ? err.error.message : err.message;
                handleError(walletName, `An exception occurred: ${errMsg || 'Unknown exception.'}`, err);
            }
        });
    </script>
</body>
</html>