<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Connect Example - Sats Connect</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; align-items: center; min-height: 90vh; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 100%; max-width: 450px; text-align: center; }
        h1 { margin-bottom: 25px; font-size: 24px; color: #1c1e21; }
        .button-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        button:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button:active { transform: translateY(1px); }
        .xverse-btn { background-color: #5630FF; color: white; }
        .xverse-btn:hover { background-color: #4520d9; }
        .unisat-btn { background-color: #FF9900; color: white; }
        .unisat-btn:hover { background-color: #e08600; }
        .magiceden-btn { background-color: #00C2FF; color: white; }
        .magiceden-btn:hover { background-color: #00a8e0; }
        #wallet-info { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background-color: #f7f7f7; text-align: left; }
        #wallet-info p { margin: 8px 0; font-size: 14px; word-wrap: break-word; }
        #wallet-info span { font-weight: 500; }
        #status.connected { color: #28a745; }
        #status.failed { color: #dc3545; }
        #error-message { margin-top: 15px; color: #dc3545; font-size: 14px; font-weight: 500; white-space: pre-wrap; }
        .provider-debug { font-size: 12px; color: #666; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Connect Your Wallet</h1>

        <div class="button-group">
            <button id="connectXverse" class="xverse-btn">Connect Xverse</button>
            <button id="connectUnisat" class="unisat-btn">Connect Unisat</button>
            <button id="connectMagicEden" class="magiceden-btn">Connect Magic Eden (Bitcoin)</button>
        </div>

        <div id="wallet-info">
            <p>Status: <span id="status">Not Connected</span></p>
            <p>Address: <span id="address">N/A</span></p>
            <p>Wallet: <span id="wallet-name">N/A</span></p>
        </div>
        <div id="error-message"></div>
        <div class="provider-debug">
            <p>Important: Open browser console (F12 or Right-click -> Inspect -> Console) for detailed logs.</p>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const addressEl = document.getElementById('address');
        const walletNameEl = document.getElementById('wallet-name');
        const errorEl = document.getElementById('error-message');

        function updateWalletInfo(walletFriendlyName, address) {
            statusEl.textContent = `Connected`;
            statusEl.className = 'connected';
            addressEl.textContent = address;
            walletNameEl.textContent = walletFriendlyName;
            errorEl.textContent = '';
            console.log(`${walletFriendlyName} Connected: Address - ${address}`);
        }

        function handleError(walletFriendlyName, errorMsg, errorObj) {
            statusEl.textContent = 'Connection Failed';
            statusEl.className = 'failed';
            addressEl.textContent = 'N/A';
            walletNameEl.textContent = walletFriendlyName || 'N/A';
            let fullErrorMsg = `${walletFriendlyName} Error: ${errorMsg}`;
            if (errorObj && errorObj.message && errorObj.message !== errorMsg) {
                fullErrorMsg += `\nInternal: ${errorObj.message}`;
            } else if (typeof errorObj === 'string' && errorObj !== errorMsg) {
                fullErrorMsg += `\nDetails: ${errorObj}`;
            }
            errorEl.textContent = fullErrorMsg;
            console.error(`${walletFriendlyName} Error: ${errorMsg}`, errorObj || '');
            if (errorObj && typeof errorObj === 'object') console.dir(errorObj);
        }

        // --- Xverse Connection (using Sats Connect approach) ---
        document.getElementById('connectXverse').addEventListener('click', async () => {
            console.log("Attempting to connect Xverse (Sats Connect method)...");
            let xverseBitcoinProvider; // This is the provider object from the Xverse extension

            if (typeof window.XverseProviders !== 'undefined' && typeof window.XverseProviders.BitcoinProvider !== 'undefined') {
                console.log('Found Xverse provider at window.XverseProviders.BitcoinProvider');
                xverseBitcoinProvider = window.XverseProviders.BitcoinProvider;
            } else if (typeof window.BitcoinProvider !== 'undefined') {
                console.log('No Xverse-specific provider found. Falling back to generic window.BitcoinProvider.');
                // We need to be reasonably sure this is Xverse or a Sats Connect compatible provider.
                // Checking for the .connect method specifically.
                if (typeof window.BitcoinProvider.connect === 'function') {
                    xverseBitcoinProvider = window.BitcoinProvider;
                    console.log('Using generic window.BitcoinProvider as it has a .connect method.');
                } else {
                     console.warn('Generic window.BitcoinProvider does not have the required .connect method for Sats Connect.');
                }
            }

            if (xverseBitcoinProvider && typeof xverseBitcoinProvider.connect === 'function') {
                const getAddressOptions = {
                    payload: {
                        purposes: ['payment'], // You can also ask for 'ordinals'
                        message: 'Sign in to connect your Bitcoin payment address.',
                        network: {
                            type: 'Mainnet' // Or 'Testnet'
                        },
                    },
                    onFinish: (response) => {
                        console.log('Xverse onFinish response:', response);
                        // response.addresses is an array of address objects
                        // e.g., [{ address: '...', publicKey: '...', type: 'p2wpkh' }]
                        if (response.addresses && response.addresses.length > 0) {
                            // Find the payment address (often p2wpkh for Bitcoin)
                            const paymentAddress = response.addresses.find(addr => addr.purpose === 'payment' || addr.type === 'p2wpkh');
                            if (paymentAddress) {
                                updateWalletInfo('Xverse', paymentAddress.address);
                            } else if (response.addresses[0].address) { // Fallback to first address if specific type not found
                                updateWalletInfo('Xverse', response.addresses[0].address);
                            } else {
                                handleError('Xverse', 'Payment address not found in response.', response);
                            }
                        } else {
                            handleError('Xverse', 'No addresses returned in onFinish response.', response);
                        }
                    },
                    onCancel: () => {
                        console.log('Xverse onCancel: User cancelled the request.');
                        handleError('Xverse', 'User cancelled connection request.');
                    },
                };

                try {
                    console.log('Xverse: Calling provider.connect("getAccounts", getAddressOptions)...');
                    // The await here waits for the user to interact with the popup.
                    // The actual address is delivered via the onFinish callback.
                    await xverseBitcoinProvider.connect('getAccounts', getAddressOptions);
                    console.log('Xverse: provider.connect call completed (user interaction finished).');
                } catch (error) {
                    // This catch block might catch errors if the .connect call itself fails synchronously,
                    // though most "user errors" like cancellation are handled by onCancel.
                    handleError('Xverse', error.message || 'An unknown error occurred during the connect call.', error);
                }
            } else {
                handleError('Xverse', 'Xverse wallet provider with .connect method not found. Please ensure Xverse extension is installed, enabled, and up to date.');
            }
        });

        // --- Unisat Connection (Keep as is from previous working version) ---
        document.getElementById('connectUnisat').addEventListener('click', async () => {
            console.log("Attempting to connect Unisat...");
            if (typeof window.unisat !== 'undefined') {
                console.log('Found Unisat provider at window.unisat:', window.unisat);
                try {
                    console.log("Unisat: Attempting window.unisat.requestAccounts()");
                    const accounts = await window.unisat.requestAccounts();
                    console.log('Unisat requestAccounts response:', accounts);
                    if (accounts && accounts.length > 0) {
                        updateWalletInfo('Unisat', accounts[0]);
                    } else {
                        handleError('Unisat', 'No accounts found or permission denied.');
                    }
                } catch (error) {
                    handleError('Unisat', error.message || 'An unknown error occurred.', error);
                }
            } else {
                handleError('Unisat', 'Unisat wallet extension not found. Please ensure it is installed, enabled, and has permissions for this page.');
            }
        });

        // --- Magic Eden (Bitcoin) Connection (Keep as is from previous debug version) ---
        document.getElementById('connectMagicEden').addEventListener('click', async () => {
            console.log("Attempting to connect Magic Eden (Bitcoin)...");
            let meProvider;
            let providerSource = "None";

            if (window.magicEden && window.magicEden.bitcoin) {
                console.log('Found window.magicEden.bitcoin object:', window.magicEden.bitcoin);
                if (typeof window.magicEden.bitcoin.request === 'function') {
                    meProvider = window.magicEden.bitcoin;
                    providerSource = "window.magicEden.bitcoin";
                } else {
                    console.warn('window.magicEden.bitcoin was found, but it does not have a .request() method. Logging object properties below.');
                    console.dir(window.magicEden.bitcoin);
                }
            }

            if (!meProvider && typeof window.BitcoinProvider !== 'undefined') {
                console.log('Magic Eden specific provider not suitable or not found. Checking generic window.BitcoinProvider object:', window.BitcoinProvider);
                if (typeof window.BitcoinProvider.request === 'function') {
                    meProvider = window.BitcoinProvider;
                    providerSource = "window.BitcoinProvider (generic fallback)";
                     console.warn('Using generic window.BitcoinProvider for Magic Eden. This might be another wallet if Magic Eden is not the default Bitcoin provider.');
                } else {
                    console.warn('Generic window.BitcoinProvider found, but it does not have a .request() method (when checking for Magic Eden). Logging object properties below.');
                    console.dir(window.BitcoinProvider);
                }
            }
            console.log(`Magic Eden: Using provider from: ${providerSource}`);

            if (meProvider) {
                try {
                    console.log("Magic Eden: Attempting provider.request({ method: 'getAccounts', params: [] })");
                    const response = await meProvider.request({ method: 'getAccounts', params: [] });
                    console.log('Magic Eden getAccounts response:', response);

                    let accounts;
                    if (Array.isArray(response) && response.length > 0) {
                        accounts = response;
                    } else if (response && Array.isArray(response.result) && response.result.length > 0) {
                        accounts = response.result;
                    }

                    if (accounts && accounts.length > 0) {
                        updateWalletInfo('Magic Eden (Bitcoin)', accounts[0]);
                    } else {
                        handleError('Magic Eden (Bitcoin)', 'No accounts found or permission denied. Response structure might be unexpected.', response);
                    }
                } catch (error) {
                    handleError('Magic Eden (Bitcoin)', error.message || 'An unknown error occurred during request.', error);
                }
            } else {
                handleError('Magic Eden (Bitcoin)', 'Compatible Magic Eden Bitcoin wallet provider not found or it lacks a .request() method.');
            }
        });
    </script>
</body>
</html>