<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Connect Example - Sats Connect</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; align-items: center; min-height: 90vh; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 100%; max-width: 450px; text-align: center; }
        h1 { margin-bottom: 25px; font-size: 24px; color: #1c1e21; }
        .button-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        button:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button:active { transform: translateY(1px); }
        .xverse-btn { background-color: #5630FF; color: white; }
        .xverse-btn:hover { background-color: #4520d9; }
        .unisat-btn { background-color: #FF9900; color: white; }
        .unisat-btn:hover { background-color: #e08600; }
        .magiceden-btn { background-color: #00C2FF; color: white; }
        .magiceden-btn:hover { background-color: #00a8e0; }
        #wallet-info { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background-color: #f7f7f7; text-align: left; }
        #wallet-info p { margin: 8px 0; font-size: 14px; word-wrap: break-word; }
        #wallet-info span { font-weight: 500; }
        #status.connected { color: #28a745; }
        #status.failed { color: #dc3545; }
        #error-message { margin-top: 15px; color: #dc3545; font-size: 14px; font-weight: 500; white-space: pre-wrap; }
        .provider-debug { font-size: 12px; color: #666; margin-top: 10px; }
    </style>
    <!-- For a real implementation, you would include jsontokens library properly -->
    <!-- e.g., <script src="https://unpkg.com/jsontokens@<version>/dist/jsontokens.js"></script> -->
</head>
<body>
    <div class="container">
        <h1>Connect Your Wallet</h1>

        <div class="button-group">
            <button id="connectXverse" class="xverse-btn">Connect Xverse</button>
            <button id="connectUnisat" class="unisat-btn">Connect Unisat</button>
            <button id="connectMagicEden" class="magiceden-btn">Connect Magic Eden (Bitcoin)</button>
        </div>

        <div id="wallet-info">
            <p>Status: <span id="status">Not Connected</span></p>
            <p>Address: <span id="address">N/A</span></p>
            <p>Wallet: <span id="wallet-name">N/A</span></p>
        </div>
        <div id="error-message"></div>
        <div class="provider-debug">
            <p>Important: Open browser console (F12 or Right-click -> Inspect -> Console) for detailed logs.</p>
            <p>Note: Magic Eden connection requires the 'jsontokens' library.</p>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const addressEl = document.getElementById('address');
        const walletNameEl = document.getElementById('wallet-name');
        const errorEl = document.getElementById('error-message');

        // Placeholder for the jsontokens library function.
        // In a real implementation, you would ensure this library is loaded.
        // For example: import { createUnsecuredToken } from 'jsontokens'; if using modules,
        // or ensure window.jsontokens.createUnsecuredToken is available from a <script> tag.
        const localJsontokens = {
            createUnsecuredToken: function(payload) {
                if (typeof jsontokens !== 'undefined' && typeof jsontokens.createUnsecuredToken === 'function') {
                    return jsontokens.createUnsecuredToken(payload);
                }
                console.warn("jsontokens library not found. Using placeholder for token creation. This will likely fail with the actual wallet.");
                // This is a highly simplified placeholder and NOT a real JWT implementation.
                // It's to illustrate the structure and allow the code flow to be tested.
                // The actual Magic Eden wallet will expect a correctly formatted JWT.
                try {
                    // A real unsecured JWT has a specific structure (header.payload.signature - signature is empty for unsecured)
                    // This is a dummy string that might not be accepted.
                    const header = { alg: "none", typ: "JWT" };
                    const encodedHeader = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
                    const encodedPayload = btoa(JSON.stringify(payload)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
                    return `${encodedHeader}.${encodedPayload}.`;
                } catch (e) {
                    console.error("Placeholder token creation failed:", e);
                    return null;
                }
            }
        };


        function updateWalletInfo(walletFriendlyName, address) {
            statusEl.textContent = `Connected`;
            statusEl.className = 'connected';
            addressEl.textContent = address;
            walletNameEl.textContent = walletFriendlyName;
            errorEl.textContent = '';
            console.log(`${walletFriendlyName} Connected: Address - ${address}`);
        }

        function handleError(walletFriendlyName, errorMsg, errorObj) {
            statusEl.textContent = 'Connection Failed';
            statusEl.className = 'failed';
            addressEl.textContent = 'N/A';
            walletNameEl.textContent = walletFriendlyName || 'N/A';
            let fullErrorMsg = `${walletFriendlyName} Error: ${errorMsg}`;
            if (errorObj && errorObj.message && errorObj.message !== errorMsg) {
                fullErrorMsg += `\nInternal: ${errorObj.message}`;
            } else if (typeof errorObj === 'string' && errorObj !== errorMsg) {
                fullErrorMsg += `\nDetails: ${errorObj}`;
            }
            errorEl.textContent = fullErrorMsg;
            console.error(`${walletFriendlyName} Error: ${errorMsg}`, errorObj || '');
            if (errorObj && typeof errorObj === 'object') console.dir(errorObj);
        }

        // --- Xverse Connection ---
        // The Xverse "Unexpected token 'ï¿½'" error is internal to the Xverse extension (v0.54.1 Beta).
        // This dApp code correctly implements their API; the error must be fixed in the extension.
        document.getElementById('connectXverse').addEventListener('click', async () => {
            console.log("Attempting to connect Xverse (Sats Connect method)...");
            let xverseBitcoinProvider; 

            if (typeof window.XverseProviders !== 'undefined' && typeof window.XverseProviders.BitcoinProvider !== 'undefined') {
                console.log('Found Xverse provider at window.XverseProviders.BitcoinProvider');
                xverseBitcoinProvider = window.XverseProviders.BitcoinProvider;
            } else if (typeof window.BitcoinProvider !== 'undefined') {
                console.log('No Xverse-specific provider. Checking generic window.BitcoinProvider for .connect method.');
                if (typeof window.BitcoinProvider.connect === 'function') { 
                    xverseBitcoinProvider = window.BitcoinProvider;
                    console.log('Using generic window.BitcoinProvider as it has a .connect method (could be Xverse).');
                } else {
                     console.warn('Generic window.BitcoinProvider does not have the required .connect method for Xverse/Sats Connect.');
                }
            }

            if (xverseBitcoinProvider && typeof xverseBitcoinProvider.connect === 'function') {
                const getAddressOptions = {
                    payload: {
                        purposes: ['payment'], 
                        message: 'Sign in to connect your Bitcoin payment address.',
                        network: { type: 'Mainnet' },
                    },
                    onFinish: (response) => {
                        console.log('Xverse onFinish response:', response);
                        if (response.addresses && response.addresses.length > 0) {
                            const paymentAddress = response.addresses.find(addr => addr.purpose === 'payment' || addr.type === 'p2wpkh') || response.addresses[0];
                            if (paymentAddress && paymentAddress.address) {
                                updateWalletInfo('Xverse', paymentAddress.address);
                            } else {
                                handleError('Xverse', 'Payment address not found in response.', response);
                            }
                        } else {
                            handleError('Xverse', 'No addresses returned in onFinish response.', response);
                        }
                    },
                    onCancel: () => {
                        console.log('Xverse onCancel: User cancelled or internal extension error.');
                        // The console shows "Xverse Error: cancel cancel" because this callback is hit due to the internal Xverse error.
                        handleError('Xverse', 'Request cancelled or failed. Check Xverse Wallet for details (internal JSON error previously observed).');
                    },
                };
                try {
                    console.log('Xverse: Calling provider.connect("getAccounts", getAddressOptions)...');
                    await xverseBitcoinProvider.connect('getAccounts', getAddressOptions);
                } catch (error) {
                    handleError('Xverse', error.message || 'Error during Xverse connect call.', error);
                }
            } else {
                handleError('Xverse', 'Xverse wallet provider with .connect method not found.');
            }
        });

        // --- Unisat Connection ---
        document.getElementById('connectUnisat').addEventListener('click', async () => {
            console.log("Attempting to connect Unisat...");
            if (typeof window.unisat !== 'undefined' && typeof window.unisat.requestAccounts === 'function') {
                console.log('Found Unisat provider at window.unisat:', window.unisat);
                try {
                    const accounts = await window.unisat.requestAccounts();
                    if (accounts && accounts.length > 0) {
                        updateWalletInfo('Unisat', accounts[0]);
                    } else {
                        handleError('Unisat', 'No accounts found or permission denied.');
                    }
                } catch (error) {
                    handleError('Unisat', error.message || 'Error during Unisat requestAccounts.', error);
                }
            } else {
                handleError('Unisat', 'Unisat wallet (window.unisat with .requestAccounts) not found.');
            }
        });

        // --- Magic Eden (Bitcoin) Connection ---
        document.getElementById('connectMagicEden').addEventListener('click', async () => {
            console.log("Attempting to connect Magic Eden (Bitcoin)...");
            let meBitcoinProvider;
            let providerSource = "None";

            if (window.magicEden && window.magicEden.bitcoin && typeof window.magicEden.bitcoin.connect === 'function') {
                meBitcoinProvider = window.magicEden.bitcoin;
                providerSource = "window.magicEden.bitcoin (direct API)";
                console.log('Using Magic Eden Bitcoin provider (window.magicEden.bitcoin.connect).');

                try {
                    const payload = {
                        purposes: ['payment', 'ordinals'], // As per ME docs
                        message: 'Connect to Magic Eden Wallet for Bitcoin.', // Optional
                        network: { type: 'Mainnet' }, // Optional
                    };
                    // This requires the jsontokens library to be correctly loaded and working.
                    const requestToken = localJsontokens.createUnsecuredToken(payload);

                    if (!requestToken) {
                        handleError('Magic Eden (Bitcoin)', 'Failed to create request token. Ensure jsontokens library is loaded.');
                        return;
                    }
                    
                    console.log("Magic Eden: Calling provider.connect(requestToken). Token:", requestToken.substring(0, 50) + "..."); // Log part of token
                    const response = await meBitcoinProvider.connect(requestToken); // Returns Promise<getAddressRespose>
                    console.log('Magic Eden connect response:', response);

                    if (response && Array.isArray(response) && response.length > 0) {
                        const paymentAddressObj = response.find(addr => addr.purpose === 'payment') || response[0];
                        if (paymentAddressObj && paymentAddressObj.address) {
                            updateWalletInfo('Magic Eden (Bitcoin)', paymentAddressObj.address);
                        } else {
                             handleError('Magic Eden (Bitcoin)', 'Address not found in response structure.', response);
                        }
                    } else {
                        handleError('Magic Eden (Bitcoin)', 'No addresses returned or permission denied.', response);
                    }
                } catch (error) {
                    handleError('Magic Eden (Bitcoin)', error.message || 'Error during Magic Eden connect call.', error);
                }

            } else {
                 // Fallback or error if ME specific provider isn't found/correct
                let specificMeIssue = "";
                if (window.magicEden && window.magicEden.bitcoin) {
                    specificMeIssue = "window.magicEden.bitcoin exists but .connect method not found as expected by docs.";
                    console.warn(specificMeIssue);
                } else {
                    specificMeIssue = "window.magicEden.bitcoin provider not found.";
                    console.warn(specificMeIssue);
                }
                
                // Optional: Try a generic EIP-1193 style provider as a last resort
                // (This was the previous behavior, but less likely to be ME if the specific API isn't met)
                if (typeof window.BitcoinProvider !== 'undefined' && typeof window.BitcoinProvider.request === 'function') {
                    console.warn('Magic Eden specific provider API not met. Attempting generic window.BitcoinProvider.request as fallback.');
                    const genericProvider = window.BitcoinProvider;
                    try {
                        const accounts = await genericProvider.request({ method: 'getAccounts', params: [] });
                        if (accounts && accounts.length > 0) {
                            updateWalletInfo('Magic Eden (Generic Fallback)', accounts[0]);
                        } else {
                            handleError('Magic Eden (Generic Fallback)', 'No accounts from generic provider.', accounts);
                        }
                    } catch (error) {
                         handleError('Magic Eden (Generic Fallback)', `Error with generic fallback: ${error.message || 'Unknown error.'}`);
                    }
                } else {
                     handleError('Magic Eden (Bitcoin)', `${specificMeIssue} No suitable provider found.`);
                }
            }
        });
    </script>
</body>
</html>