<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Connect Example - Sats Connect</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; align-items: center; min-height: 90vh; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 100%; max-width: 450px; text-align: center; }
        h1 { margin-bottom: 25px; font-size: 24px; color: #1c1e21; }
        .button-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        button:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button:active { transform: translateY(1px); }
        .xverse-btn { background-color: #5630FF; color: white; }
        .xverse-btn:hover { background-color: #4520d9; }
        .unisat-btn { background-color: #FF9900; color: white; }
        .unisat-btn:hover { background-color: #e08600; }
        .magiceden-btn { background-color: #00C2FF; color: white; }
        .magiceden-btn:hover { background-color: #00a8e0; }
        #wallet-info { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background-color: #f7f7f7; text-align: left; }
        #wallet-info p { margin: 8px 0; font-size: 14px; word-wrap: break-word; }
        #wallet-info span { font-weight: 500; }
        #status.connected { color: #28a745; }
        #status.failed { color: #dc3545; }
        #error-message { margin-top: 15px; color: #dc3545; font-size: 14px; font-weight: 500; white-space: pre-wrap; }
        .provider-debug { font-size: 12px; color: #666; margin-top: 10px; }
        .critical-note { color: red; font-weight: bold; }
    </style>
    <!-- 
        CRITICAL: Include the jsontokens library for Magic Eden Wallet connection.
        Using version 0.4.0 from unpkg.com. If this version also shows internal errors
        (like "Cannot convert BigInt to number" from jsontokens.js on page load),
        the library itself is not working correctly in your environment from this CDN source.
    -->
    <script src="https://unpkg.com/jsontokens@0.4.0/dist/jsontokens.js"></script>
</head>
<body>
    <div class="container">
        <h1>Connect Your Wallet</h1>

        <div class="button-group">
            <button id="connectXverse" class="xverse-btn">Connect Xverse</button>
            <button id="connectUnisat" class="unisat-btn">Connect Unisat</button>
            <button id="connectMagicEden" class="magiceden-btn">Connect Magic Eden (Bitcoin)</button>
        </div>

        <div id="wallet-info">
            <p>Status: <span id="status">Not Connected</span></p>
            <p>Address: <span id="address">N/A</span></p>
            <p>Wallet: <span id="wallet-name">N/A</span></p>
        </div>
        <div id="error-message"></div>
        <div class="provider-debug">
            <p>Important: Open browser console (F12 or Right-click -> Inspect -> Console) for detailed logs.</p>
            <p class="critical-note">Note: Magic Eden connection REQUIRES the 'jsontokens' library to be correctly loaded (see &lt;head&gt; of this HTML). If 'jsontokens.js' itself has errors on load (like 'BigInt' issues), connection will fail.</p>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const addressEl = document.getElementById('address');
        const walletNameEl = document.getElementById('wallet-name');
        const errorEl = document.getElementById('error-message');
        
        function getJsonTokensLib() {
            if (typeof jsontokens !== 'undefined' && typeof jsontokens.createUnsecuredToken === 'function') {
                console.log("jsontokens library appears to be loaded and jsontokens.createUnsecuredToken is a function.");
                return jsontokens;
            }
            console.error("CRITICAL: jsontokens library not found OR jsontokens.createUnsecuredToken is not a function. This is likely due to an error WITHIN the jsontokens.js script itself during page load (e.g., 'Cannot convert BigInt to number'). Magic Eden connection will fail. Ensure the library from the CDN loads and initializes without errors in your browser environment.");
            return {
                createUnsecuredToken: function(payload) {
                    console.error("Attempted to use dummy createUnsecuredToken because jsontokens library is missing or failed to initialize properly.");
                    return null; 
                }
            };
        }

        function updateWalletInfo(walletFriendlyName, address) {
            statusEl.textContent = `Connected`;
            statusEl.className = 'connected';
            addressEl.textContent = address;
            walletNameEl.textContent = walletFriendlyName;
            errorEl.textContent = '';
            console.log(`${walletFriendlyName} Connected: Address - ${address}`);
        }

        function handleError(walletFriendlyName, errorMsg, errorObj) {
            statusEl.textContent = 'Connection Failed';
            statusEl.className = 'failed';
            addressEl.textContent = 'N/A';
            walletNameEl.textContent = walletFriendlyName || 'N/A';
            let fullErrorMsg = `${walletFriendlyName} Error: ${errorMsg}`;
            if (errorObj) {
                const errorObjMsg = errorObj.message || (typeof errorObj === 'string' ? errorObj : JSON.stringify(errorObj));
                if (errorObjMsg && errorObjMsg !== errorMsg) {
                    fullErrorMsg += `\nDetails: ${errorObjMsg}`;
                }
            }
            errorEl.textContent = fullErrorMsg;
            console.error(`${walletFriendlyName} Error: ${errorMsg}`, errorObj || 'No additional error object.');
            if (errorObj && typeof errorObj === 'object') console.dir(errorObj);
        }

        // --- Xverse Connection ---
        document.getElementById('connectXverse').addEventListener('click', async () => {
            console.log("Attempting to connect Xverse (Sats Connect method)...");
            let xverseBitcoinProvider; 
            if (typeof window.XverseProviders !== 'undefined' && typeof window.XverseProviders.BitcoinProvider !== 'undefined') {
                xverseBitcoinProvider = window.XverseProviders.BitcoinProvider;
            } else if (typeof window.BitcoinProvider !== 'undefined' && typeof window.BitcoinProvider.connect === 'function') { 
                xverseBitcoinProvider = window.BitcoinProvider;
            }

            if (xverseBitcoinProvider && typeof xverseBitcoinProvider.connect === 'function') {
                const getAddressOptions = {
                    payload: { purposes: ['payment'], message: 'Sign in to connect your Bitcoin payment address.', network: { type: 'Mainnet' } },
                    onFinish: (response) => {
                        if (response.addresses && response.addresses.length > 0) {
                            const paymentAddress = response.addresses.find(addr => addr.purpose === 'payment' || addr.type === 'p2wpkh') || response.addresses[0];
                            if (paymentAddress && paymentAddress.address) updateWalletInfo('Xverse', paymentAddress.address);
                            else handleError('Xverse', 'Payment address not found in Xverse response.', response);
                        } else handleError('Xverse', 'No addresses returned in Xverse onFinish response.', response);
                    },
                    onCancel: () => handleError('Xverse', 'Xverse request cancelled or failed. This may be due to an internal Xverse Wallet error (JSON parsing issue observed in extension v0.54.1 Beta). Please report this to Xverse support.'),
                };
                try { await xverseBitcoinProvider.connect('getAccounts', getAddressOptions); }
                catch (error) { handleError('Xverse', error.message || 'Error during Xverse connect call.', error); }
            } else handleError('Xverse', 'Xverse wallet provider with .connect method not found.');
        });

        // --- Unisat Connection ---
        document.getElementById('connectUnisat').addEventListener('click', async () => {
            if (typeof window.unisat !== 'undefined' && typeof window.unisat.requestAccounts === 'function') {
                try {
                    const accounts = await window.unisat.requestAccounts();
                    if (accounts && accounts.length > 0) updateWalletInfo('Unisat', accounts[0]);
                    else handleError('Unisat', 'No accounts found or permission denied by Unisat.');
                } catch (error) { handleError('Unisat', error.message || 'Error during Unisat requestAccounts.', error); }
            } else handleError('Unisat', 'Unisat wallet (window.unisat with .requestAccounts) not found.');
        });

        // --- Magic Eden (Bitcoin) Connection ---
        document.getElementById('connectMagicEden').addEventListener('click', async () => {
            console.log("Attempting to connect Magic Eden (Bitcoin)...");
            const effectiveJsonTokens = getJsonTokensLib(); 

            if (window.magicEden && window.magicEden.bitcoin && typeof window.magicEden.bitcoin.connect === 'function') {
                const meBitcoinProvider = window.magicEden.bitcoin;
                console.log('Using Magic Eden Bitcoin provider (window.magicEden.bitcoin.connect).');

                try {
                    const payload = {
                        purposes: ['payment', 'ordinals'],
                        message: 'Connect to Magic Eden Wallet for Bitcoin.',
                        network: { type: 'Mainnet' },
                    };
                    const requestToken = effectiveJsonTokens.createUnsecuredToken(payload);

                    if (!requestToken) {
                        handleError('Magic Eden (Bitcoin)', 'Failed to create request token. The jsontokens library (from unpkg.com) failed to load or initialize correctly, possibly due to an internal error like "Cannot convert BigInt to number". Check browser console for errors from jsontokens.js on page load.', null);
                        return;
                    }
                    
                    console.log("Magic Eden: Calling provider.connect(requestToken). Token (prefix):", typeof requestToken === 'string' ? requestToken.substring(0, 60) + "..." : "[Invalid Token Generated]");
                    const response = await meBitcoinProvider.connect(requestToken);
                    console.log('Magic Eden connect response object:', response);

                    if (response && response.addresses && Array.isArray(response.addresses) && response.addresses.length > 0) {
                        const addressesArray = response.addresses;
                        const paymentAddressObj = addressesArray.find(addr => addr.purpose === 'payment') || addressesArray[0];
                        if (paymentAddressObj && paymentAddressObj.address) {
                            updateWalletInfo('Magic Eden (Bitcoin)', paymentAddressObj.address);
                        } else {
                             handleError('Magic Eden (Bitcoin)', 'Address not found in response.addresses structure.', response);
                        }
                    } else {
                        handleError('Magic Eden (Bitcoin)', 'No valid addresses array returned from Magic Eden or permission denied. This usually happens if the token was invalid (due to jsontokens library issues) or the user denied the request in the wallet.', response);
                    }
                } catch (error) {
                    let detailedErrorMessage = error.message || 'Error during Magic Eden connect call.';
                    if ( (error.message && error.message.toLowerCase().includes("bigint")) || (error.stack && error.stack.toLowerCase().includes("jsontokens")) ) {
                         detailedErrorMessage += " This indicates an internal error in the jsontokens library.";
                    }
                    handleError('Magic Eden (Bitcoin)', detailedErrorMessage, error);
                }
            } else {
                let specificMeIssue = "Magic Eden provider (window.magicEden.bitcoin) not found or its .connect method is missing.";
                if (window.magicEden && window.magicEden.bitcoin && typeof window.magicEden.bitcoin.connect !== 'function') {
                    specificMeIssue = "window.magicEden.bitcoin was found, but it does not have the documented .connect() method.";
                }
                console.warn(specificMeIssue);
                if (typeof window.BitcoinProvider !== 'undefined' && typeof window.BitcoinProvider.request === 'function') {
                    console.warn('Attempting generic window.BitcoinProvider.request as fallback for Magic Eden.');
                    try {
                        const accounts = await window.BitcoinProvider.request({ method: 'getAccounts', params: [] });
                        if (accounts && accounts.length > 0) updateWalletInfo('Magic Eden (Generic Fallback)', accounts[0]);
                        else handleError('Magic Eden (Generic Fallback)', 'No accounts from generic provider.', accounts);
                    } catch (error) { handleError('Magic Eden (Generic Fallback)', `Error with generic fallback: ${error.message || 'Unknown error.'}`, error); }
                } else {
                     handleError('Magic Eden (Bitcoin)', `${specificMeIssue} No suitable Bitcoin provider found.`);
                }
            }
        });
    </script>
</body>
</html>