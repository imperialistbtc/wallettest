<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Connect Example - Sats Connect</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; align-items: center; min-height: 90vh; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 100%; max-width: 450px; text-align: center; }
        h1 { margin-bottom: 25px; font-size: 24px; color: #1c1e21; }
        .button-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        /* ... (rest of your styles) ... */
        .xverse-btn { background-color: #5630FF; color: white; }
        .xverse-btn:hover { background-color: #4520d9; }
        .unisat-btn { background-color: #FF9900; color: white; }
        .unisat-btn:hover { background-color: #e08600; }
        .magiceden-btn { background-color: #00C2FF; color: white; }
        .magiceden-btn:hover { background-color: #00a8e0; }
        #wallet-info { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background-color: #f7f7f7; text-align: left; }
        #wallet-info p { margin: 8px 0; font-size: 14px; word-wrap: break-word; }
        #wallet-info span { font-weight: 500; }
        #status.connected { color: #28a745; }
        #status.failed { color: #dc3545; }
        #error-message { margin-top: 15px; color: #dc3545; font-size: 14px; font-weight: 500; white-space: pre-wrap; }
        .provider-debug { font-size: 12px; color: #666; margin-top: 10px; }
        .critical-note { color: red; font-weight: bold; }
    </style>
    <!-- 
        Attempting to use sats-connect library from CDN.
        This should manage its own jsontokens dependency.
        Note: The version 0.2.2 is an example, a newer one might be available or preferable.
    -->
    <script src="https://cdn.jsdelivr.net/npm/sats-connect@0.2.2/dist/sats-connect.js"></script>
</head>
<body>
    <div class="container">
        <h1>Connect Your Wallet</h1>

        <div class="button-group">
            <button id="connectXverse" class="xverse-btn">Connect Xverse</button>
            <button id="connectUnisat" class="unisat-btn">Connect Unisat</button>
            <button id="connectMagicEden" class="magiceden-btn">Connect Magic Eden (Bitcoin)</button>
        </div>

        <div id="wallet-info">
            <p>Status: <span id="status">Not Connected</span></p>
            <p>Address: <span id="address">N/A</span></p>
            <p>Wallet: <span id="wallet-name">N/A</span></p>
        </div>
        <div id="error-message"></div>
        <div class="provider-debug">
            <p>Important: Open browser console (F12 or Right-click -> Inspect -> Console) for detailed logs.</p>
            <p class="critical-note">This version uses the 'sats-connect' library for Xverse and Magic Eden.</p>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const addressEl = document.getElementById('address');
        const walletNameEl = document.getElementById('wallet-name');
        const errorEl = document.getElementById('error-message');

        function updateWalletInfo(walletFriendlyName, address) {
            statusEl.textContent = `Connected`;
            statusEl.className = 'connected';
            addressEl.textContent = address;
            walletNameEl.textContent = walletFriendlyName;
            errorEl.textContent = '';
            console.log(`${walletFriendlyName} Connected: Address - ${address}`);
        }

        function handleError(walletFriendlyName, errorMsg, errorObj) {
            statusEl.textContent = 'Connection Failed';
            statusEl.className = 'failed';
            addressEl.textContent = 'N/A';
            walletNameEl.textContent = walletFriendlyName || 'N/A';
            let fullErrorMsg = `${walletFriendlyName} Error: ${errorMsg}`;
            if (errorObj) {
                const errorObjMsg = errorObj.message || (typeof errorObj === 'string' ? errorObj : JSON.stringify(errorObj));
                if (errorObjMsg && errorObjMsg !== errorMsg) {
                    fullErrorMsg += `\nDetails: ${errorObjMsg}`;
                }
            }
            errorEl.textContent = fullErrorMsg;
            console.error(`${walletFriendlyName} Error: ${errorMsg}`, errorObj || 'No additional error object.');
            if (errorObj && typeof errorObj === 'object') console.dir(errorObj);
        }

        // Common getAddressOptions for Sats Connect compatible wallets
        const commonGetAddressOptions = {
            payload: {
                purposes: ['payment'],
                message: 'Sign in to connect your Bitcoin payment address.',
                network: {
                    type: 'Mainnet' 
                },
            },
            onFinish: (response, walletName) => { // Modified to pass walletName
                console.log(`${walletName} onFinish response:`, response);
                // response.addresses is an array of address objects
                if (response.addresses && response.addresses.length > 0) {
                    const paymentAddress = response.addresses.find(addr => addr.purpose === 'payment' || addr.type === 'p2wpkh') || response.addresses[0];
                    if (paymentAddress && paymentAddress.address) {
                        updateWalletInfo(walletName, paymentAddress.address);
                    } else {
                        handleError(walletName, 'Payment address not found in response.', response);
                    }
                } else {
                    handleError(walletName, 'No addresses returned in onFinish response.', response);
                }
            },
            onCancel: (walletName) => { // Modified to pass walletName
                console.log(`${walletName} onCancel: User cancelled or internal error.`);
                handleError(walletName, 'Request cancelled or failed. This could be due to user action or an internal wallet error.');
            },
        };

        // --- Xverse Connection (using sats-connect library) ---
        document.getElementById('connectXverse').addEventListener('click', async () => {
            console.log("Attempting to connect Xverse (using sats-connect library)...");
            if (typeof satsConnect === 'undefined' || typeof satsConnect.getAddress !== 'function') {
                handleError('Xverse', 'sats-connect library not found or getAddress function is missing. Check CDN script tag.');
                return;
            }
            if (typeof window.XverseProviders === 'undefined' || typeof window.XverseProviders.BitcoinProvider === 'undefined') {
                 handleError('Xverse', 'Xverse Wallet provider (window.XverseProviders.BitcoinProvider) not found. Is Xverse installed?');
                return;
            }

            try {
                // The Xverse provider itself is not passed to satsConnect.getAddress,
                // sats-connect handles provider discovery implicitly based on its design with compatible wallets.
                // However, the Xverse documentation (and your previous code) has the provider call .connect itself.
                // Sats-connect's getAddress is a utility that wraps this. Let's assume getAddress uses the
                // globally available compatible provider if one exists and is active.
                await satsConnect.getAddress({
                    ...commonGetAddressOptions,
                    // Override onFinish and onCancel to include the specific wallet name
                    onFinish: (response) => commonGetAddressOptions.onFinish(response, 'Xverse'),
                    onCancel: () => commonGetAddressOptions.onCancel('Xverse'),
                    // The Xverse documentation shows providing the provider in some examples,
                    // but sats-connect generally aims to auto-detect. If this direct call fails,
                    // it implies sats-connect might expect to be initialized differently or the provider isn't auto-detected as hoped.
                    // For now, relying on sats-connect's auto-detection or its internal handling.
                    // If Xverse has a specific way it wants to be invoked via sats-connect's getAddress,
                    // that might involve providing the provider to an init function of sats-connect first.
                    // For now, direct call as per many generic sats-connect examples.
                });
                console.log('Xverse: satsConnect.getAddress call initiated.');
            } catch (error) {
                // This catch is for errors in the getAddress call itself, not async errors handled by onFinish/onCancel
                handleError('Xverse', error.message || 'An unknown error occurred calling satsConnect.getAddress.', error);
            }
        });
        
        // --- Unisat Connection (remains the same) ---
        document.getElementById('connectUnisat').addEventListener('click', async () => {
            if (typeof window.unisat !== 'undefined' && typeof window.unisat.requestAccounts === 'function') {
                try {
                    const accounts = await window.unisat.requestAccounts();
                    if (accounts && accounts.length > 0) updateWalletInfo('Unisat', accounts[0]);
                    else handleError('Unisat', 'No accounts found or permission denied by Unisat.');
                } catch (error) { handleError('Unisat', error.message || 'Error during Unisat requestAccounts.', error); }
            } else handleError('Unisat', 'Unisat wallet (window.unisat with .requestAccounts) not found.');
        });

        // --- Magic Eden (Bitcoin) Connection (using sats-connect library) ---
        document.getElementById('connectMagicEden').addEventListener('click', async () => {
            console.log("Attempting to connect Magic Eden (Bitcoin) (using sats-connect library)...");
            if (typeof satsConnect === 'undefined' || typeof satsConnect.getAddress !== 'function') {
                handleError('Magic Eden (Bitcoin)', 'sats-connect library not found or getAddress function is missing. Check CDN script tag.');
                return;
            }
            // Magic Eden documentation suggests compatibility with Sats Connect methods.
            // We assume window.magicEden.bitcoin is the provider that sats-connect will interact with,
            // or that sats-connect can discover it if it's the active Bitcoin provider.
            if (!(window.magicEden && window.magicEden.bitcoin)) {
                handleError('Magic Eden (Bitcoin)', 'Magic Eden Bitcoin provider (window.magicEden.bitcoin) not found.');
                return;
            }
            
            try {
                // Similar to Xverse, relying on satsConnect.getAddress to handle the interaction
                // with the globally available and compatible Magic Eden provider.
                await satsConnect.getAddress({
                    ...commonGetAddressOptions,
                     payload: { // Use ME specific details if necessary, or commonGetAddressOptions is fine
                        purposes: ['payment', 'ordinals'], // ME docs suggest these purposes
                        message: 'Connect to Magic Eden Wallet for Bitcoin.',
                        network: { type: 'Mainnet' },
                    },
                    // Override onFinish and onCancel to include the specific wallet name
                    onFinish: (response) => commonGetAddressOptions.onFinish(response, 'Magic Eden (Bitcoin)'),
                    onCancel: () => commonGetAddressOptions.onCancel('Magic Eden (Bitcoin)'),
                });
                console.log('Magic Eden (Bitcoin): satsConnect.getAddress call initiated.');
            } catch (error) {
                handleError('Magic Eden (Bitcoin)', error.message || 'An unknown error occurred calling satsConnect.getAddress.', error);
            }
        });
    </script>
</body>
</html>